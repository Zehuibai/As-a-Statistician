# Multiple-Comparison

 
## Introduction

### Multiplicity Problem


There are real effects from multiplicity. 

* confounding effects
* nonresponse effects
* placebo effects
* learning effects
* carryover effects 

The problem with all statistical tests is the fact that the (overall) error rate increases with increasing number of tests. $$1 - (1 - \alpha)^m.$$



### Error Rates

#### Comparisonwise Error Rate (CER)

Typical inferences are performed using the $95 \%$ confidence level or $5 \%$ significance level. In either case, the comparisonwise error rate (CER) is $5 \%$. For confidence intervals, CER is defined as
$$\mathrm{CER}=P(\text{Interval does not contain the parameter}).$$
A typical two-sided confidence interval has the form

(parameter estimate) $\pm$ (critical value) $\times$ (standard error of the estimate).

For example, if the parameter of interest is a population mean $\mu$, and the data are normally distributed, then the usual two-sided $95 \%$ confidence interval for $\mu$ is
$$
\bar{y} \pm t_{975, n-1} \times s_{y} / \sqrt{n}
$$
where
- $\bar{y}$ is the estimate of the population mean
- $s_{y}$ is the sample standard deviation
o $n$ is the sample size
- $s_{y} / \sqrt{n}$ is the standard error of the estimated mean.


The critical value is $t_{975, n-1}$, which is the $1-0.05 / 2$ quantile of the $t$ distribution with $n-1$ degrees of freedom. A one-sided upper confidence interval for $\mu$ might be all values below
$$
\bar{y}+t_{.95, n-1} \times s_{y} / \sqrt{n}
$$
For tests of hypotheses, CER is defined as
$$
\mathrm{CER}=P\left(\text { Reject } H_{0} \mid H_{0}\right. \text { is true). }
$$




#### Familywise Error Rate (FWE) 

**FWE for Simultaneous Confidence Intervals**

The FWE is the probability of at least one erroneous inference, defined for simultaneous confidence intervals as 
$$\text{FWE (at least one interval is incorrect) 1 (all intervals are correct).}$$

**FWE for Multiple Tests of Hypotheses**

The family-wise error rate is defined as the probability of rejecting at least one of the true $H_0$ 

In the case of multiple tests of hypotheses, some of the hypotheses $H_{0 j}$ could be true, and others could be false. Suppose the true state of nature is that the particular null hypotheses corresponding to $j_{1}, \ldots, j_{m}$ are true, and all other null hypotheses are false. In other words, $H_{0 j_{1}}, H_{0 j_{2}}, \ldots, H_{0 j_{m}}$ are true, and the remaining $(k-m)$ hypotheses are false. The FWE is then defined as

$$FWE =P( \text{reject at least one of} H_{0 j_{1}}, H_{0 j_{2}}, \ldots, H_{0 j_{m}} \mid H_{0 j_{1}}, H_{0 j_{2}}, \ldots, H_{0 j_{m}} \text{all are true})$$.


#### Control of the FWE: Weak and Strong

An MCP is said to control the FWE in the weak sense if it controls the FWE under the complete null configuration, but not under all other configurations. Despite the fact that the terms “weak control” and “strong control” are used in conjunction with FWE, you should note that they really refer to different error rates. **Weak control refers only to controlling the probability that the complete null hypothesis is rejected**, and allows Type I errors in excess of the usual 5% value (for example, for the component hypotheses). 

A method that controls the FWE in the strong sense will result in a **Type I error for any component hypothesis no more than 5% of the time**.

> 如果MCP在完全空配置下而不是在所有其他配置下控制FWE，则说它在较弱的意义上控制FWE。 尽管事实上“弱控制”和“强控制”与FWE结合使用，但您应注意，它们实际上指的是不同的错误率。 弱控制仅是指控制拒绝完全无效假设的可能性，并且允许类型I错误超过通常的5％值（例如，对于分量假设）。
> 从严格意义上讲，控制FWE的方法将在不超过5％的时间内针对任何组件假设导致I型错误。


#### Directional Decisions and Type III Error Rates

A directional error (sometimes called a Type III error) is defined as the probability of misclassifying the sign of an effect. If you reject the hypothesis H0 : μ = 0 in favor of the (twosided) alternative HA : μ ≠ 0 using a CER= 0.05 level test, can you then claim that the sign of the true mean μ is the same as the sign of the estimated mean y ?

A type III error is where you correctly reject the null hypothesis, but it’s rejected for the wrong reason. This compares to a Type I error (incorrectly rejecting the null hypothesis) and a Type II error (not rejecting the null when you should). Type III errors are not considered serious, as they do mean you arrive at the correct decision. They usually happen because of random chance and are a rare occurrence.

You can also think of a Type III error as giving the right answer (i.e. correctly rejecting the null) to the wrong question. In other words, both your null and alternate hypotheses may be poorly worded or completely incorrect.

For MCPs, the Type III FWE is the probability that the sign of any tested effect is misclassified. 


#### False Discovery Rate (FDR)

Benjamini and Hochberg (1995) referred to the expected proportion of erroneously rejected null
hypotheses among the rejected ones as the False Discovery Rate, or FDR. Formally, for a given
family of k hypotheses and a given MCP, let R= number of hypotheses rejected, and let V = the
(unknown) number of erroneously rejected ones. Define V/R = 0 in case R=0. Then FDR is the
expected value of V/R

$$
\begin{array}{cccc}
\hline & H_{0} \text { accepted } & H_{0} \text { rejected } & \text { Total } \\
\hline H_{0} \text { true } & m-V & V & m \\
H_{0} \text { false } & k-m-R+V & R-V & k-m \\
\text { Total } & k-R & R & k \\
\hline
\end{array}
$$

$$
\mathrm{FDR}=E(V / R)
$$
(assuming $0 / 0$ is defined as 0 ), whereas
$$
\mathrm{FWE}=P(V>0)
$$
Under the overall null hypothesis, FDR and FWE are equal, since in this case $V / R=1$ when there is at least one rejection, and $V / R=0$ when there are no rejections.  





### The adjusted P

Marginal p-value is based on the marginal p-values, which do not account for a multiplicity adjustment. 

The adjusted P value is the smallest familywise significance level at which a particular comparison will be declared statistically significant as part of the multiple comparison testing. A separate adjusted P value is computed for each comparison in a family of comparisons. 

The following show the R code about teh comparsion of adjusted and un-adjusted p-values

```
library(multcomp)
data(thuesen,package = "ISwR")
thuesen <- read.sas7bdat("~/Desktop/SASUniversityEdition/myfolders/Daten/thuesen.sas7bdat")

thuesen.lm <- lm(short.velocity ~ blood.glucose,data = thuesen)
thuesen.mc <- glht(thuesen.lm, linfct = diag(2))

## With adjustment.
summary(thuesen.mc, 
        test = adjusted(type = "bonferroni"))
## without adjustment.
summary(thuesen.mc, test = univariate())
```
Furthermore, there are different methods for p value adjust.

```
Input = ("
Food               Raw.p
 Blue_fish         .34
 Bread             .594
 Butter            .212
 Carbohydrates     .384
 Cereals_and_pasta .074
 Dairy_products    .94
 Eggs              .275
 Fats              .696
 Fruit             .269
 Legumes           .341
 Nuts              .06
")
Data = read.table(textConnection(Input),header=TRUE)
## Order data by p-value
Data = Data[order(Data$Raw.p),]

## Perform p-value adjustments and add to data frame
Data$Bonferroni = 
      p.adjust(Data$Raw.p, 
               method = "bonferroni")
Data$BH = 
      p.adjust(Data$Raw.p, 
               method = "BH")
Data$Holm = 
      p.adjust(Data$ Raw.p, 
               method = "holm")
Data$Hochberg = 
      p.adjust(Data$ Raw.p, 
               method = "hochberg")
Data$Hommel = 
      p.adjust(Data$ Raw.p, 
               method = "hommel")
Data$BY = 
      p.adjust(Data$ Raw.p, 
               method = "BY")

                Food Raw.p Bonferroni     BH Holm Hochberg    Hommel BY
11              Nuts 0.060      0.660 0.4070 0.66     0.66 0.5485714  1
5  Cereals_and_pasta 0.074      0.814 0.4070 0.74     0.74 0.5920000  1
3             Butter 0.212      1.000 0.5280 1.00     0.94 0.8700000  1
9              Fruit 0.269      1.000 0.5280 1.00     0.94 0.9280000  1
7               Eggs 0.275      1.000 0.5280 1.00     0.94 0.9280000  1
1          Blue_fish 0.340      1.000 0.5280 1.00     0.94 0.9400000  1
10           Legumes 0.341      1.000 0.5280 1.00     0.94 0.9400000  1
4      Carbohydrates 0.384      1.000 0.5280 1.00     0.94 0.9400000  1
2              Bread 0.594      1.000 0.7260 1.00     0.94 0.9400000  1
8               Fats 0.696      1.000 0.7656 1.00     0.94 0.9400000  1
6     Dairy_products 0.940      1.000 0.9400 1.00     0.94 0.9400000  1
```

### Basic Statistical Concepts

The hypotheses described here are for the two-sample t-test, a common test for comparing two groups. 
The assumptions of the two-sample t-test are important: random, independent samples from the two groups, 
common variances, and normally distributed data. 


- The null hypothesis is $H_{0}: \mu_{1}=\mu_{2} ;$ that is, the hypotheses that the population means are equal.
- The alternative hypothesis is $H_{A}: \mu_{1} \neq \mu_{2} ;$ that is, the hypotheses that the population means are not equal.
- The test statistic is $T=\frac{\bar{X}_{1}-\bar{X}_{2}}{s_{p} \sqrt{\frac{1}{n_{1}}+\frac{1}{n_{2}}}}$, where $s_{p}^{2}=\frac{\left(n_{1}-1\right) s_{1}^{2}+\left(n_{2}-1\right) s_{2}^{2}}{n_{1}+n_{2}-2}$.
- The decision rule is to reject $H_{0}$ if $|T| \geq t_{1-\alpha / 2, n-2}$, where $t_{1-\alpha / 2, n-2}$ is the critical value.
- The $p$ -value is the probability of observing a test statistic as large as or larger than the $|T|$ that was observed in the study, assuming the null hypothesis is true.  


By construction, the $p$ -value is found $\leq \alpha$ wherever $|T| \geq t_{1-\alpha / 2, n-2} .$ Thus, when all of the assumptions are satisfied,
$$
P\left(p \leq \alpha \mid H_{0} \text { is true }\right)=\alpha
$$
This leads to an important point:

**When the null hypothesis is true and when all assumptions are satisfied, the $p$ -value has a uniform distribution.**


From the parameter, the adjusted and unadjusted p value can be calculated

```
## Calculation without adjustment.
## regression coefficients β and their covariance matrix

betahat <- coef(thuesen.lm)
Vbetahat <- vcov(thuesen.lm)
##  compute two individual t test statistics and correlation matrix
C <- diag(2)
Sigma <- diag(1 / sqrt(diag(C %*% Vbetahat %*% t(C))))
t <- Sigma %*% C %*% betahat
Cor <- Sigma %*% (C %*% Vbetahat %*% t(C)) %*% t(Sigma)


## Use the pmvt function of the mvtnorm package to calculate the adjusted p value from the basic bivariate t distribution
library("mvtnorm")
thuesen.df <- nrow(thuesen) - length(betahat)
q <- sapply(abs(t), function(x) 1 - pmvt(-rep(x, 2), 
                                         rep(x, 2), 
                                         corr = Cor,
                                         df = thuesen.df))
##  获得了多重调整的p值 q1 <0.001且q2 = 0.064

##  compute the critical value u1−α 计算临界值
delta <- rep(0, 2)
myfct <- function(x, conf) {
  lower <- rep(-x, 2)
  upper <- rep(x, 2)
  pmvt(lower, upper, df = thuesen.df, corr = Cor,
           delta, abseps = 0.0001)[1] - conf
}
u <- uniroot(myfct, lower = 1, upper = 5, conf = 0.95)$root
round(u, 3)
```


### Functions in glht package in R

| Functions                                                      |  Descriptions                               |
|----------------------------------------------------------------|---------------------------------------------|
| `glht.mc$model`                                                | The fitted model                            |
| `glht.mc$linfct`                                               | linear conflict functions                   |
| `glht.mc$vcov`                                                 | Covariance matrix                           |
| `glht.res <- summary(glht.mc)  glht.res$test$pvalues`          | P-values                                    |
| `summary(warpbreaks.mc, test = Ftest())`                       | Global F-Test                               |
| `summary(warpbreaks.mc, test = Chisqtest())`                   | Wald测试                                    |
| `summary(warpbreaks.mc, test = univariate())`                  | 未调整的p值, 不考虑多重性执行了m个单独t检验 |
| `summary(warpbreaks.mc, test = adjusted(type = "bonferroni"))` | Bonferroni校正                              |




## Bonferroni and Šidák Methods

### LSD (least significance difference)

least significant difference method. First proposed by Fisher, it is essentially a t-test.

For Two independent sample t test:

$$t=\frac{\bar{X}_{1}-\bar{X}_{2}}{\sqrt{S_{c}^{2}\left(\frac{1}{n_{1}}+\frac{1}{n_{2}}\right)}}$$
$$S_{c}^{2}=\frac{\left(n_{1}-1\right) S_{1}^{2}+\left(n_{2}-1\right) S_{2}^{2}}{n_{1}+n_{2}-2}$$
is the variance of the joint estimate of the two samples, under the premise that the sample variance is uniform

The LSD method also performs a t-test of pairwise comparison. The difference is that under the premise of meeting the homogeneity of variance, the LSD method uses the joint variance of **all samples** to estimate the standard error of the mean difference, rather than the **joint variance of the two samples** to be compared. Take the comparison of the mean difference between the three samples as an example, the formula is

<!-- LSD法采用所有样本的联合方差来估计均数差的标准误，而不是要比较的两个样本的联合方差。 -->

$$\begin{aligned}
&S_{c}^{2}=\frac{\left(n_{1}-1\right) S_{1}^{2}+\left(n_{2}-1\right) S_{2}^{2}+\left(n_{3}-1\right) S_{3}^{2}}{n_{1}+n_{2}+n_{3}-3}
\end{aligned}$$

The LSD method calculates the smallest significant difference, namely
$$\begin{aligned}
&L S D=t_{\alpha / 2} \sqrt{S_{c}^{2}\left(\frac{1}{n_{1}}+\frac{1}{n_{2}}\right)}
\end{aligned}$$

> LSD法单次比较的检验水准仍然为α。LSD法检验的灵敏度最高，但是会因为对比的频数增加使得第一类型错误概率增加。为解决该问题，便出现了Sidak法和Bonferroni法。


### Šidák

Sidak法的也是一种t检验，计算公式和LSD法的相同。但是Sidak法对a进行了调整。如果有k组, 对k组进行两两比较的次数为 $c=\frac{k(k-1)}{2}$ 那么做完c次比较，累积犯一类错误的概率为:
$1-\left(1-\alpha_{a}\right)^{c}$ 令上面的公式值等于0.05, 由此可以反推出调整后的 $\alpha_{a} \quad$ 。例如进行6次事后比 较, 则Sidak法的=0.0085, 以 $\alpha_{a}$ 作为单次比较的显著性水平，显然 $\alpha_{a}$ 变小了。由于 $\alpha_{a}$ 减
你，结论趋于接受无效假设, 因此该方法要比LSD法保守的多。

The rationale for this method is the Boole inequality: 
$$
P\left(A_{1} \text { or } A_{2} \text { or } \ldots \text { or } A_{k}\right) \leq P\left(A_{1}\right)+P\left(A_{2}\right)+\cdots+P\left(A_{k}\right)
$$

$$
P\left(\left\{\text { Reject } H_{01}\right\} \text { or }\left\{\text { Reject } H_{02}\right\}\right) \leq P\left(\text { Reject } H_{01}\right)+P\left(\text { Reject } H_{02}\right)
$$

For the Šidák method, recall that you can reject an individual hypothesis $H_{0 j}$ if $p_{j} \leq 1-(1-\alpha)^{1 / k}$;
or equivalently, when $1-\left(1-p_{j}\right)^{k} \leq \alpha$, where $\alpha$ is the desired FWE level. This gives you the Šidák adjusted $p$ -values.
Šidák Adjusted $p$ -value for Hypothesis $H_{0 j}$;
$$
\tilde{p}_{j}=1-\left(1-p_{j}\right)^{k} .
$$



### Bonferroni

The Bonferroni method is similar to the Sidak method, and α is also adjusted on the basis of the LSD method. The adjustment method is based on Bonferroni's inequality. If there are k groups, the calculation formula is
$$\alpha^* = \alpha / k$$

The Bonferroni method is generally considered to be the most conservative. When the number of comparisons is small, the effect of this method is better. When the number of comparisons is large (such as k>10), the adjustment of $\alpha$ is somewhat overcorrected and the effect is not as good as Sidak

```
library(multcomp)
## Create a matrix where each *row* is a contrast
K <- rbind(c(1, -1/2, -1/2), ## ctrl vs. average of trt1 and trt2
           c(1, -1, 0))      ## ctrl vs. trt1
fit.gh <- glht(fit, linfct = mcp(group = K))

## Individual p-values
summary(fit.gh, test = adjusted("none"))

## Bonferroni corrected p-values
summary(fit.gh, test = adjusted("bonferroni"))
```

While the Boole inequality is directly applicable to multiple hypothesis testing, the Bonferroni
inequality is directly applicable to **simultaneous confidence intervals**. As an example, suppose
that you have constructed k=10 simultaneous confidence intervals, all at the CER level
0.05/k=0.05/10=0.005, corresponding to 99.5% confidence intervals. Then the simultaneous
confidence level is 

$$
\begin{array}{l}
P(\{\text { Interval } 1 \text { correct }\} \text { and } \ldots \text { and }\{\text { Interval } 10 \text { correct }\}) \\
\geq 1-\{P(\text { Interval } 1 \text { incorrect })+\cdots+P(\text { Interval } 10 \text { incorrect })\} \\
=1-10(0.005) \\
=0.95 .
\end{array}
$$

Bonferroni Adjusted $p$ -value for Hypothesis $H_{0 j}$;
$$
\tilde{p}_{j}=\left\{\begin{array}{ccc}
k p_{j} & \text { if } & k p_{j} \leq 1 \\
1 & \text { if } & k p_{j}>1
\end{array}\right.
$$


**Bonferroni and Šidák Adjusted p-Values Using the DATA Step**

```
data pvals1;
 input test pval @@;
 bon_adjp = min(1,10*pval);
 sid_adjp = 1 - (1-pval)**10;
datalines;
1 0.0911 2 0.8912
3 0.0001 4 0.5718
5 0.0132 6 0.9011
7 0.2012 8 0.0289
9 0.0498 10 0.0058
;
proc sort data=pvals1 out=pvals1;
 by pval;
proc print data=pvals1;
run; 
```

**Bonferroni and Šidák Adjusted p-Values Using PROC MULTTEST**

```
proc multtest inpvalues(pval)=pvals1 bon sid out=outp;
proc sort data=outp out=outp;
 by pval;
proc print data=outp label;
run;
```


Bonferroni and Šidák methods are easy to implement, and they correspond naturally to
confidence intervals. Šidák's method provides slightly more power, but occasionally does not
control the FWE. However, when confidence intervals are not required, adaptive procedures are
more powerful, although they might not control the FWE in some cases. Simulation studies
should be used to understand this issue.

* For inferences with dependent data: ⇒ Use Bonferroni tests or intervals.
* For inferences with independent data: ⇒ Use Šidák tests or intervals.



### Schweder-Spjøtvoll p-Value Plot 

This plot, which is very useful for assessing multiplicity, depicts the relationship between values $q=1-p$ and their rank order. Specifically, if $q_{(1)} \leq \ldots \leq q_{(k)}$ are the ordered values of the $q$ 's, then $q_{(1)}=1-p_{(k)}, q_{(2)}=1-p_{(k-1)}$, etc. The method is to plot the $\left(j, q_{(j)}\right)$ pairs. If the hypotheses all are truly null, then the $p$ -values will behave like a sample from the uniform distribution, and the graph should lie approximately on a straight diagonal line. Deviations from linearity, particularly points in the upper-right corner of the graph that are below the extended trend line from the points in the lower-left corner, suggest hypotheses that are false, since their $p$ -values are too small to be consistent with the uniform distribution.

```
*** Schweder-Spjøtvoll p-Value Plot Using PROC MULTTEST ;
data pvals1;
 input test pval @@;
 bon_adjp = min(1,10*pval);
 sid_adjp = 1 - (1-pval)**10;
datalines;
1 0.0911 2 0.8912
3 0.0001 4 0.5718
5 0.0132 6 0.9011
7 0.2012 8 0.0289
9 0.0498 10 0.0058
;

ods graphics on;
proc multtest inpvalues(pval)=pvals1 plots= RawUniformPlot;
run;
ods graphics off;
```

```{r Schweder-Spjøtvoll p-Value Plot, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Schweder-Spjøtvoll (Uniform Probability) Plot"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Schweder-Spjøtvoll 1.png")
```

How does the plot look when there are no true effects

```
ods graphics on;
proc multtest inpvalues(probt)=ttests plots= RawUniformPlot;
run;
ods graphics off;
```

```{r Plot of p-Values for the Cold Study, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Plot of p-Values for the Cold Study"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Schweder-Spjøtvoll 2.png")
```

**Adaptive Methods**

FWE of an MCP depends upon the number of true null hypotheses, m. In order to protect the FWE in all possible circumstances, you had to protect it for the complete null hypothesis where all nulls are true (i.e., where m=k). Thus, in the Bonferroni method, you use k as a divisor for the critical value (and as a multiplier for the adjusted p-value). If you know m, the number of true nulls, then you may use m as a divisor (or multiplier for adjusted p-values) instead of k, and still control the FWE. From the examination of the Schweder-Spjøtvoll plot, you can estimate the total number of true null hypotheses $\hat m$, and modify the critical value of the Bonferroni procedure by rejecting any hypothesis$H_{0 j}$ for which $p_{j} \leq \alpha / \hat{m} .$


**Adaptive Holm (AHOLM) method specified in the following program.**

```
*** Estimating the Number of Null Hypotheses;
ods graphics on;
proc multtest inpvalues(pval)=pvals1
 plots= RawUniformPlot aholm;
run;
ods graphics off;
```
```{r g Hochberg and Benjamini’s, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Estimating the Number of True Nulls Using Hochberg and Benjamini’s Method"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Schweder-Spjøtvoll 3.png")
```






## MCP among Treatment Means in the One-Way Balanced ANOVA 
 

### LS-Means    

Least square means are means for groups that are adjusted for means of other factors in the model. 

A least square mean, or LS-mean, is the predicted average within a certain category for a “balanced”
population; for this reason, the LS-means are also called the “estimated population marginal
means” (Searle, Speed, and Milliken, 1980). 

LS-means correspond to Type III tests in the same way that arithmetic means correspond to
Type I tests; as with Type III tests, they are intended to be used with complicated, possibly
unbalanced models as simple means can be used with simple models. Also, as Type III tests are
identical to Type I tests for simple models, so LS-means are the same as arithmetic means when
the latter are appropriate.

> 最小二乘均值或LS均值是“均衡”人群在特定类别内的预测平均值；因此，LS均值也称为“估计的人口边际均值”（Searle，Speed和Milliken，1980年）。 LS-均值对应于III型测试，其计算方式与I型测试相同。与III型测试一样，它们旨在与复杂的，可能不平衡的模型一起使用，因为简单的方法可以与简单的模型一起使用。此外，由于类型III的测试与简单模型的类型I的测试相同，因此在适当的情况下，LS均值与算术平均值相同。


```
*** Selling Prices of Homes;
data House;
 input Location$ Price Sqfeet Age @@;
datalines;
A 213.5 2374 4 A 219.9 2271 8 A 227.9 2088 5
A 192.5 1645 8 A 203.0 1814 6 A 242.1 2553 7
A 220.5 1921 9 A 205.5 1854 2 A 201.2 1536 9
A 194.7 1677 3 A 229.0 2342 5 A 208.7 1862 4
A 199.7 1894 7 A 212.0 1774 9 A 204.8 1476 8
A 186.1 1466 7 A 203.5 1800 8 A 193.0 1491 5
A 199.5 1749 8 A 198.1 1690 7 A 244.8 2741 5
A 196.3 1460 5 A 195.1 1614 6 A 225.8 2244 6
A 226.9 2165 6 A 204.7 1828 4 B 174.2 1503 6
B 169.9 1689 6 B 177.0 1638 2 B 167.0 1276 6
B 198.9 2101 9 B 181.2 1668 5 B 185.7 2123 4
B 199.8 2208 5 B 155.7 1273 8 B 220.1 2519 4
B 209.1 2303 6 B 182.4 1800 3 B 202.7 2336 8
B 192.0 2100 6 B 184.1 1697 4 C 190.8 1674 4
C 198.2 2307 7 C 194.6 2152 5 C 187.9 1948 9
D 202.5 2258 2 D 181.3 1965 6 D 186.1 1772 3
D 194.7 2385 1 D 164.7 1345 4 D 193.5 2220 8
D 180.1 1883 8 D 192.3 2012 6 D 180.6 1898 5
E 205.3 2362 7 E 206.3 2362 7 E 184.3 1963 9
E 176.6 1941 7 E 182.4 1975 5 E 198.8 2529 6
E 186.8 2079 5 E 188.5 2190 4 E 177.5 1897 5
E 186.9 1946 4
; 
```

**Calculate the least squares mean in R**

Remark:

* 最小二乘均值根据参考表格（reference grid）
    * 参考水平的组合构成参考表格
    * 如果是因子，那么因子的每个水平作为参考水平；
    * 如果是协变量，那么用协变量的总体均值作为参考水平；
* 一旦建立了参考表格，最小二乘均值就是基于表格的简单预测，或者说是预测值列表的边际均值（marginal means）。


```{r,echo = T,message = FALSE, error = FALSE, warning = FALSE}
library(lsmeans)
head(oranges)
str(oranges)

### Build a model
### store and day are factor variables, so they are used as fixed effects
### price1 and price2 are used as covariates;

oranges.lm1 <- lm(sales1 ~ price1 + price2 + store + day , data = oranges)
anova(oranges.lm1)

### Create a reference Grid
oranges.rg1 <- ref.grid(oranges.lm1)
oranges.rg1

### Obtain the predicted value of different reference level combinations
### Using summary() or predict()
oranges.rg1.prediction <- summary(oranges.rg1)
oranges.rg1.prediction

### Get LS Mean for day
lsmeans(oranges.rg1,"day")
```


**coefficients**

Construct confidence intervals for and perform hypothesis tests on linear combinations using the ESTIMATE statement;
The ESTIMATE statement specifies the coefficients in the vector $\mathbf{c}$ that define the linear combination $\mathbf{c}^{\prime} \boldsymbol{\beta}$ that you want to estimate. 


```
proc glm data=House;
 class Location;
 model Price = Location Sqfeet Age;
 estimate 'gamma' Intercept 1 Location 0 0 0 0 0 Sqfeet 0 Age 0 ;
 estimate 'm1-m2' Intercept 0 Location 1 -1 0 0 0 Sqfeet 0 Age 0 ;
run; quit; 
```

**Inference for Estimable Linear Combinations**

$$
\frac{\mathbf{c}^{\prime} \hat{\beta}-\mathbf{c}^{\prime} \boldsymbol{\beta}}{\text { s.e. }\left(\mathbf{c}^{\prime} \boldsymbol{\beta}\right)} \sim t_{d / \varepsilon}
$$
where the standard error of $\mathbf{c}^{\prime} \hat{\boldsymbol{\beta}}$ is
$$
\text { s.e. }\left(\mathbf{c}^{\prime} \hat{\boldsymbol{\beta}}\right)=\hat{\sigma} \sqrt{\mathbf{c}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{c}} \text { . }
$$
The $t$ -statistic for testing $H_{0}: \mathbf{c}^{\prime} \boldsymbol{\beta}=0$ is then
$$
t=\frac{\mathbf{c}^{\prime} \hat{\boldsymbol{\beta}}}{\text { s.e. }\left(\mathbf{c}^{\prime} \hat{\boldsymbol{\beta}}\right)}
$$
and the two-sided $p$ -value is
$$
p=P\left(\left|T_{d j e}\right| \geq|t|\right)=2 P\left(T_{d f e} \geq|t|\right) .
$$

In order to compute the confidence interval for the 'm1-m2' linear combination, use the
CLPARM option on the MODEL statement, as in the following program. 

```
proc glm data=House;
 class Location;
 model Price = Location Sqfeet Age / clparm;
 estimate 'm1-m2' Intercept 0 Location 1 -1 0 0 0 Sqfeet 0 Age 0 ;
run; quit;
```



### The Multivariate t Distribution

Most of the classical MCPs fall under the general umbrella of “MaxT methods”; that is, they are based on the distribution of the **maximum of multiple t-statistics.**

Confidence intervals for the estimable functions $\mathbf{c}_{i}^{\prime} \boldsymbol{\beta}$ have the form
$$
\mathbf{c}^{\prime} \hat{\boldsymbol{\beta}} \pm c_{\alpha} s . e .\left(\mathbf{c}^{\prime} \hat{\boldsymbol{\beta}}\right)
$$
where $c_{\alpha}$ is a critical value that is selected to make the $\mathrm{FWE}=\alpha$ for the set of confidence intervals for the family $\mathbf{c}_{1}^{\prime} \boldsymbol{\beta}, \mathbf{c}_{2}^{\prime} \boldsymbol{\beta}, \ldots, \mathbf{c}_{k}^{\prime} \boldsymbol{\beta}$.
 
To find the right $c_{\alpha}$, you can use the joint distribution of the statistics
$$
T_{i}=\frac{\mathbf{c}_{i}^{\prime} \hat{\boldsymbol{\beta}}-\mathbf{c}_{i}^{\prime} \boldsymbol{\beta}}{\operatorname{s.e.}\left(\mathbf{c}_{i}^{\prime} \hat{\boldsymbol{\beta}}\right)}, \quad i=1, \ldots, k
$$
The collection of random variables $\left\{T_{1}, T_{2}, \ldots, T_{k}\right\}$ has the multivariate $t$ distribution when the classical linear model assumptions are valid.

 

If $\mathbf{Z}=\left(Z_{1}, \ldots, Z_{k}\right)$ is distributed as multivariate normal with zero mean with known covariance matrix $\mathbf{R}$, and if $V$ is distributed as Chi-Square with $d f$ degrees of freedom, independent of $\mathbf{Z}$, then
$$
\mathbf{T}=\frac{\mathbf{Z}}{\sqrt{V / d f}}
$$
has the multivariate $t$ distribution with dispersion matrix $\mathbf{R}$ and degrees of freedom $d f$.

First, define the contrast matrix
$$
\mathbf{C}=\left(\mathbf{c}_{1}, \ldots, \mathbf{c}_{k}\right)
$$
Then you can write the estimates of the set of $k$ estimable linear combinations as the $k \times 1$ vector $\mathbf{C}^{\prime} \hat{\boldsymbol{\beta}}$, which is distributed as multivariate normal when the assumptions are true:
$$
\mathbf{C}^{\prime} \hat{\boldsymbol{\beta}} \sim \boldsymbol{N}_{k}\left(\mathbf{C}^{\prime} \boldsymbol{\beta}, \sigma^{2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C}\right)
$$
(If the X matrix contains random variables, then this is the conditional distribution, given the observed $\mathbf{X}$.)
From this expression you can derive $Z$ -statistics:
$$
Z_{i}=\frac{\mathbf{c}_{i}^{\prime} \hat{\boldsymbol{\beta}}-\mathbf{c}_{i}^{\prime} \boldsymbol{\beta}}{\sigma \sqrt{\mathbf{c}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{c}}} \sim N(0,1)
$$
You can write the entire set of $Z$ -statistics in matrix/vector notation as
$$
\mathbf{Z}=\left(\sigma^{2} \mathbf{D}\right)^{-1 / 2}\left(\mathbf{C}^{\prime} \hat{\boldsymbol{\beta}}-\mathbf{C}^{\prime} \boldsymbol{\beta}\right),
$$
where $\mathbf{D}$ is the diagonal matrix having diagonal elements $\mathbf{c}_{i}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{c}_{i}$, thus
$$
\mathbf{Z} \sim N_{k}\left(0, \mathbf{D}^{-1 / 2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C D}^{-1 / 2}\right)
$$
The $\mathbf{R}$ matrix is the **covariance matrix** of the $\mathbf{Z}$ vector:
$$
\mathbf{R}=\mathbf{D}^{-1 / 2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C} \mathbf{D}^{-1 / 2}
$$

Notice that
- $\mathbf{R}$ is the correlation matrix of the $Z \mathrm{~s}$ as there are $1 \mathrm{~s}$ on the diagonal.
- $\mathbf{R}$ is a known matrix, depending on no unknown parameters.
- The correlations between the $Z$ 's depend on
    + the set of linear combinations to be estimated (determined by C), and
    + the design of the study and the model used for the analysis (determined by $\mathbf{X}$ ).


Now, to get the vector of $t$ statistics, you can write
$$
\mathbf{T}=\frac{\mathbf{Z}}{s / \sigma}
$$
To remove the $\sigma$ in the $Z$ statistic and replace it with $s$.
Under the model assumptions,
$$
\frac{d f \times s^{2}}{\sigma^{2}} \sim \chi_{d f}^{2}
$$
and is independent of $\hat{\boldsymbol{\beta}}$, thus establishing the representation of $\mathbf{T}$ as
$$
\mathbf{T}=\frac{\mathbf{Z}}{\sqrt{V / d f}}
$$
and hence that it has the multivariate $t$ distribution with dispersion matrix $\mathbf{R}=\mathbf{D}^{-1 / 2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C} \mathbf{D}^{-1 / 2}$

**Obtaining the R Matrix for Multiple Comparisons**

```
proc orthoreg data=House;
 class Location;
 model Price = Location Sqfeet Age;
 lsmestimate Location
 'm1-m2' 1 -1 0 0 0,
 'm2-m3' 0 1 -1 0 0,
 'm3-m4' 0 0 1 -1 0,
 'm4-m5' 0 0 0 1 -1 / corr;
run;
```

### Calculating the Critical Value $c_{\alpha}$

Suppose for simplicity that the critical value $c_{\alpha}$ is for two-sided intervals and tests. There are many ways that you can find it, or at least approximate it. First, you might try to integrate the multivariate $t$ distribution and solve for $c_{\alpha}$ :
$$
\int_{-c_{\alpha}}^{c_{c}} \ldots \int_{-c_{\alpha}}^{c_{c}} f\left(t_{1}, \ldots, t_{k} ; d f, \mathbf{R}\right) d t_{1} \ldots d t_{k}=1-\alpha
$$
This approach is often impractical because the complicated form of the multivariate $t$ distribution function $f\left(t_{1}, \ldots, t_{k} ; d f, \mathbf{R}\right)$ precludes analytical integration; numerical integration methods also can founder if there are too many dimensions $k$.

The value $c_{\alpha}$ is found the following ways:

- **Exact Analytic Solution**: When the data are balanced and the comparisons are simple, the multivariate $t$ integral simplifies and is solvable in terms of known and special mathematical distribution functions like "Tukey's studentized range distribution" and "Dunnett's range distribution"  
- **Conservative Analytic Solution**: In some cases with unbalanced data and/or more complex comparisons, the exact analytic solution provides a conservative solution in that the $c_{\alpha}$ is larger than it needs to be.
- **Approximate Analytic Solution**: In some cases, with unbalanced data and/or more complex comparisons, the exact analytic solution provides an approximate solution in that the $c_{\alpha}$ is perhaps larger than it needs to be, or perhaps smaller.
- **Simple Monte Carlo Solution**: By simulating many multivariate $t$ vectors, you can estimate the $1-\alpha$ quantile of $\max T$.
- **Control Variate Monte Carlo Solution**: This method also proceeds by simulating multivariate $t$ vectors, but then using control variates to reduce the variance of the estimate of the $1-\alpha$ quantile of $\max \mathrm{T}$.
- **Quasi-Monte Carlo Solution**: This method proceeds by approximating the multiple integral shown above by using a systematic grid of $t$ vectors. The method can often provide much better accuracy with far fewer $t$ vectors (Genz and Bretz, 2009).


 

### All Pairwise Comparisons and Studentized Range Distribution

In general, there are such comparisons. 

$$
\left(\begin{array}{l}
g \\
2
\end{array}\right)=\frac{g !}{2 !(g-2) !}=\frac{g(g-1)}{2}
$$
For all simultaneous pairwise comparisons $\mu_{i}-\mu_{i^{\prime}}, 1 \leq i, i^{\prime} \leq g$, the critical value $c_{\alpha}$ must satisfy
$$
P\left(\bar{y}_{i}-\bar{y}_{i^{\prime}}-c_{\alpha} \hat{\sigma} \sqrt{2 / n} \leq \mu_{i}-\mu_{i^{\prime}} \leq \bar{y}_{i}-\bar{y}_{i^{\prime}}+c_{\alpha} \hat{\sigma} \sqrt{2 / n}, \text { for all } i, i^{\prime}\right)=1-\alpha
$$
or equivalently
$$
P\left(\max _{i, i^{\prime}} \frac{\left|\left(\bar{y}_{i}-\mu_{i}\right)-\left(\bar{y}_{i^{\prime}}-\mu_{i^{\prime}}\right)\right|}{\hat{\sigma} \sqrt{2 / n}} \leq c_{\alpha}\right)=1-\alpha
$$


This formula shows the “MaxT”. In the balanced ANOVA, the
MaxT statistic has a particularly simple form because the denominator standard error
$\hat{\sigma} \sqrt{2 / n}$ is the same for all $t$ -statistics. This simplification, along with the special structure of the set of all pairwise comparisons, allows for $c_{\alpha}$ to be calculated analytically from the studentized range distribution. When the standard errors differ for the various $t$ -statistics, more complex approximations such as simulation-based methods are needed.


**Studentized Range Distribution**

If $Z_{1}, \ldots, Z_{g}$ are independent standard normal random variables, and $V$ is a random variable distributed as chi-square with $v$ degrees of freedom, independent of the $Z \mathrm{~s}$, then
$$
Q_{g, v}^{R}=\max _{i, i^{\prime}} \frac{\left|Z_{i}-Z_{i^{\prime}}\right|}{\sqrt{V / v}}
$$
has the studentized range distribution with parameters $g$ and $r$.
With this definition and some algebraic manipulation, along with well-known results concerning distributions involving normally distributed variables, you can show that $c_{\alpha}$ satisfies
$$
P\left(\frac{Q_{g, g(n-1)}^{R}}{\sqrt{2}} \leq c_{\alpha}\right)=1-\alpha
$$
or equivalently that
$$
c_{\alpha}=\frac{q_{1-\alpha, g, g(n-1)}^{R}}{\sqrt{2}}
$$
where $q_{1-\alpha_{m}}^{R}$ is the $1-\alpha$ quantile of the studentized range distribution.


**“Hand Calculation” of Studentized Range Critical Value**

The quantiles $q_{1-\alpha_{\alpha}}^{R}$ of the studentized range distribution can be calculated using the PROBMC
function in SAS, which evaluates the cumulative probability distribution function of the random variable $Q_{g, v}^{R} .$ 

```
data;
 qval = probmc("RANGE",.,.95,45,5);
 c_alpha = qval/sqrt(2);
run; 
```

**Implementation**

Obtaining Pairwise Comparisons Using the LSMEANS Statement

```
proc glm data=House;
 class Location;
 model Price = Location Sqfeet Age;
 lsmeans Location / tdiff;
run; quit;
```

Pairwise Comparisons with a Control, For example, perhaps region B is considered the premium region, and you wish
to know how other regions compare with it.

```
proc glm data=House;
 class Location;
 model Price = Location Sqfeet Age;
 lsmeans Location / tdiff=control('B');
run; quit;
```

### Tukey's Method for All Pairwise Comparisons

Confidence intervals for all pairwise comparisons in the balanced ANOVA that use the critical value $c_{\alpha}=q_{1-\alpha, g, g(n-1)}^{R} / \sqrt{2}$ from the studentized range distribution are commonly said to be constructed by "Tukey's Method," after Tukey (1953). The intervals may also be called "Tukey intervals" in this case. When testing hypotheses $H_{0}: \mu_{i}-\mu_{i^{\prime}}=0$, either by checking to see if 0 is inside the Tukey interval or by comparing $\left|t_{i, i^{\prime}}\right|$ to $c_{\alpha}=q_{1-\alpha, g, g(n-1)}^{R} / \sqrt{2}$, the tests are called "Tukey tests."


**Compare the Tukey intervals with the Bonferroni intervals**

Since there are $5 \times 4 / 2=10$ pairwise comparisons among the five groups, the Bonferroni critical value uses $\alpha^{\prime}=0.05 / 10=0.005$, and the critical value nnis $t_{0.9975,45}=2.9521$. The reason for the difference between the Bonferroni critical value and the Tukey critical value, $2.9521$ vs. $2.84145$, is that the Tukey critical value is **based on the precise distribution of the 10 pairwise statistics** $\left\{\left(\bar{y}_{i}-\mu_{i}\right)-\left(\bar{y}_{i^{\prime}}-\mu_{i^{\prime}}\right)\right\} /(\hat{\sigma} \sqrt{2 / n}) .$ There are correlations among these statistics because there are
many common random elements. For example, the statistics $\left\{\left(\bar{y}_{1}-\mu_{1}\right)-\left(\bar{y}_{2}-\mu_{2}\right)\right\} /(\hat{\sigma} \sqrt{2 / n})$ and $\left\{\left(\bar{y}_{1}-\mu_{1}\right)-\left(\bar{y}_{3}-\mu_{3}\right)\right\} /(\hat{\sigma} \sqrt{2 / n})$ are **correlated** because both contain the common random elements $\bar{y}_{1}$ and $\hat{\sigma}$.

In summary, Tukey's intervals control the FWE precisely (under the assumptions of the model), while the Bonferroni intervals over-control and the unadjusted intervals under-control.


**SAS Implementation**

```
***  PROC GLM Calculation of Tukey Adjusted p-Values;
proc glm data=Wloss;
 class Diet;
 model Wloss=Diet;
 lsmeans Diet/pdiff adjust=tukey;
run; quit;
```


**Simultaneous Intervals for Mean Differences**

* Unadjusted Intervals
* Bonferroni Intervals
* Tukey Intervals

```
proc glm data=Wloss;
 class Diet;
 model Wloss=Diet;
 means Diet/cldiff t bon tukey;
run; 
```



**R Implementation**

```
## contrMat specify other contrast matrices in advance, such as "Dunnett", "Williams"
## Tukey 1
data(warpbreaks)
warpbreaks.aov <- aov(breaks ~ tension, data = warpbreaks)
warpbreaks.mc <- glht(warpbreaks.aov, 
                      linfct = mcp(tension = "Tukey"))
                      
## alternative 1
glht(warpbreaks.aov,linfct = mcp(tension = c("M - L = 0",
                                             "H - L = 0",
                                             "H - M = 0")))

## alternative 2                  
contr <- rbind("M - L" = c(-1,  1, 0),
               "H - L" = c(-1,  0, 1),
               "H - M" = c( 0, -1, 1));
glht(warpbreaks.aov, linfct = mcp(tension = contr))

## alternative 3
glht(warpbreaks.aov,
     linfct = cbind(0, contr %*% contr.treatment(3)))
     
     
## Multiple Comparisons of Means: Tukey Contrasts
## Linear Hypotheses:
##           Estimate
## M - L == 0  -10.000
## H - L == 0  -14.722
## H - M == 0   -4.722


## Calculate and plot simultaneous confidence intervals
warpbreaks.ci <- confint(warpbreaks.mc, level = 0.95)
warpbreaks.ci
 
## Unadjusted (marginal) confidence interval
confint(warpbreaks.mc, calpha = univariate_calpha())
```


**The Tukey Adjusted p-Value**

$$
\tilde{p}_{i, i^{\prime}}=P\left(Q_{g, g(n-1)}^{R} \geq \sqrt{2}\left|t_{i, i}\right|\right)
$$
By comparison, the ordinary (unadjusted) $p$ -value is given by $p_{i, i^{\prime}}=2 P\left(T_{g(n-1)} \geq t_{i, i} \mid\right)$, where $T_{V}$ denotes a Student's $t$ -distributed random variable with $v$ degrees of freedom (here, $v=g(n-1))$.

```
**** “By Hand” Calculation of Raw and Tukey Adjusted p-Values;
data;
 n=10; g=5; df=g*(n-1);
 Mean_A=12.05; Mean_B=11.02; MSE=0.993422;
 tstat_AB = (Mean_A-Mean_B)/(sqrt(MSE)*sqrt(2/n));
 raw_p = 2*(1-probt(abs(tstat_AB),df));
 adj_p = 1-probmc('RANGE',sqrt(2)*abs(tstat_AB),.,df,g);
run; 

```

 

### Displaying Pairwise Comparisons Graphically

**Graphical Presentation for Comparing Means: LINES Option SAS**

LINES option, which provides a listing of the means in descending order
and a text graph that displays the results of the tests. 

```
proc glm data=Wloss;
 class Diet;
 model Wloss=Diet;
 means Diet/tukey lines;
run; 
```
**Graphical Presentation for Comparing Means: The Diffogram**

An alternative presentation of the simultaneous confidence intervals is known as the mean-mean scatterplot (Hsu, 1996); in SAS, it is called a diffogram. First, all non-redundant pairs $\left(\bar{y}_{i}, \bar{y}_{i^{\prime}}\right)$
are plotted on a two-dimensional plot. Then the confidence intervals are represented as $-45^{\circ}$ lines emanating symmetrically from the centers $\left(\bar{y}_{i}, \bar{y}_{i}\right)$, scaled in such a way that the line covers the $45^{\circ}$ line when the interval covers 0 ; see Figure $4.2$ below. 

```
ods graphics on;
proc glm data=Wloss;
 class Diet;
 model Wloss=Diet;
 lsmeans Diet/cl adjust=tukey;
run;
quit;
ods graphics off; 
```


```{r Turkey Diffogram, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Diffogram indicating Comparisons of Diets"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Turkey_Diffgram.png")
```


**R Implementation**

```
## CI Plot
plot(warpbreaks.ci, main = "", 
     ylim = c(0.5, 3.5),xlab = "Breaks")
```

```{r Turkey CI Plots, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Turkey CI Plots"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Turkey_Plots.png")
```

```
## CI Boxplots
warpbreaks.cld <- cld(warpbreaks.mc)
plot(warpbreaks.cld)
```

```{r Turkey CI Boxplots, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: CI Boxplots"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Turkey_Boxplots.png")
```



### Dunnett's Two-Sided Comparisons with a Control and Dunnett's Two-Sided Range Distribution

If you want to make a claim about whether the treated groups' means are either larger or
smaller than the control group mean, then you should use two-sided intervals. 

$\bar{y}_{0}$ denote the mean of the control group, you need a $c_{\alpha}$ for which
$$
P\left(\bar{y}_{i}-\bar{y}_{0}-c_{\alpha} \hat{\sigma} \sqrt{2 / n} \leq \mu_{i}-\mu_{0} \leq \bar{y}_{i}-\bar{y}_{0}+c_{\alpha} \hat{\sigma} \sqrt{2 / n}, \text { for all } i\right)=1-\alpha
$$
Algebraically rearranging terms, you see that $c_{\alpha}$ must satisfy
$$
P\left(\max _{i} \frac{\left|\left(\bar{y}_{i}-\mu_{i}\right)-\left(\bar{y}_{0}-\mu_{0}\right)\right|}{\hat{\sigma} \sqrt{2 / n}} \leq c_{\alpha}\right)=1-\alpha
$$
the critical value $c_{\alpha}$ can be calculated analytically from Dunnett's two-sided range distribution.


**Dunnett's two-sided range distribution**

If $Z_{0}, Z_{1}, \ldots, Z_{g}$ are independent standard normal random variables, and $V$ is a random variable
distributed as chi-square with $v$ degrees of freedom, independent of the $Z \mathrm{~s}$, then
$$
Q_{g, v}^{D 2}=\frac{\max _{i}\left|Z_{i}-Z_{0}\right|}{\sqrt{2 V / v}}
$$
has Dunnett's two-sided range distribution with parameters $g$ and $v$.

```
*** “By Hand Calculation” of Dunnett's Two-Sided Critical Value;
data;
 c_alpha = probmc("DUNNETT2",.,.95,21,6);
run;
proc print;
run;
```

```
### Calculate critical values for Dunnett procedure given alpha, df1 and df2 in R;

qDunnett <- function (p, df, k, rho,
                      type = c("two-sided", "one-sided"))
{
  type <- match.arg(type)
  alpha <- 1 - p
  if (type == "two-sided") {
    alpha <- alpha/2
  }
  S <- matrix(rho, nrow=k, ncol=k) + (1-rho)*diag(k)
  if (type == "two-sided") {
    f <- function(d, df, k, S, p) {
      mnormt::sadmvt(df=df, lower=rep(-d,k), upper=rep(d,k),
                      mean=rep(0,k), S=S, maxpts=2000*k) - p
    }
  }
  else {
    f <- function(d, df, k, S, p) {
      mnormt::pmt(d, S=S, df=df) - p
    }
  }
  d <- uniroot(f,
               df = df, k = k, S = S, p=p,
               lower=qt(1 - alpha, df),
               upper=qt(1 - alpha/k, df),
               tol=.Machine$double.eps, maxiter=5000)$root
  return(d)
}


p <- 0.95; df <- 24; rho <- 0.5; k <- 3
nCDunnett::qNCDun(p=p, nu=df, rho=rho,
                  delta=rep(0,times=k), two.sided=T)
qDunnett(p, df, k, rho)
````


**SAS Implementation**

```
data Tox;
 input Trt @;
 do j = 1 to 4;
 input Gain @; output;
 end;
datalines;
0 97.76 102.56 96.08 125.12
1 91.28 129.20 90.80 72.32
2 67.28 85.76 95.60 73.28
3 80.24 64.88 64.88 78.56
4 96.08 98.24 77.84 95.36 
5 57.68 89.84 98.48 92.72
6 68.72 85.28 68.72 74.24
;

*** Boxplots;
ods graphics on;
proc glm data=Tox;
 class Trt;
 model Gain=Trt;
 means Trt/dunnett;
run; quit;
ods graphics off;
```


**Displaying Two-Sided Dunnett Comparisons Graphically**

```
means Trt/dunnett;

*** Or;
lsmeans Trt/adjust=dunnett;
```

**R Implementation**


```
data("recovery", package = "multcomp")
recovery.aov <- aov(minutes ~ blanket, data = recovery)
recovery.mc <- glht(recovery.aov,
                    linfct = mcp(blanket = "Dunnett"),
                    alternative = "less")   ## one-sided test
                    
## Alternative
contr <- rbind("b1 -b0" = c(-1, 1, 0, 0), 
               "b2 -b0" = c(-1, 0, 1, 0),
               "b3 -b0" = c(-1, 0, 0, 1))
summary(glht(recovery.aov, linfct = mcp(blanket = contr),
             alternative = "less"))
             
## KI und Plot
recovery.ci <- confint(recovery.mc, level = 0.95)
```


**Specify linear combination variante from Dunnett**

```
## Variante from Dunnett
contr2 <- rbind("b2 -b0" = c(-1,  0, 1, 0),
                "b2 -b1" = c( 0, -1, 1, 0),
                "b3 -b0" = c(-1,  0, 0, 1),
                "b3 -b1" = c( 0, -1, 0, 1))
summary(glht(recovery.aov, linfct = mcp(blanket = contr2),
             alternative = "less"))
             
             
Linear Hypotheses:
            Estimate Std. Error t value Pr(<t)    
b2 -b0 >= 0  -7.4667     1.6038  -4.656 <0.001 ***
b2 -b1 >= 0  -5.3333     2.1150  -2.522 0.0278 *  
b3 -b0 >= 0  -1.6667     0.8848  -1.884 0.1054    
b3 -b1 >= 0   0.4667     1.6383   0.285 0.9150    
```







### Dunnett's One-Sided Comparisons with a Control

If you want to reject the null hypothesis only when the treated groups' means are on one side of
(e.g., lower than) the control group mean, and if you are willing to *ignore any difference in the opposite direction*, then you can *get more power* by using one-sided tests or one-sided
confidence intervals. 

Thus, to obtain the critical points for lower-tailed inferences, you need a $c_{\alpha}$ for which
$$
P\left(\mu_{i}-\mu_{0} \leq \bar{y}_{i}-\bar{y}_{0}+c_{\alpha} \hat{\sigma} \sqrt{2 / n}, \text { for all } i\right)=1-\alpha
$$
For upper-tailed inferences, you need a $c_{\alpha}$ for which
$$
P\left(\mu_{i}-\mu_{0} \geq \bar{y}_{i}-\bar{y}_{0}-c_{\alpha} \hat{\sigma} \sqrt{2 / n}, \text { for all } i\right)=1-\alpha
$$
Rearranging terms algebraically and, in the case of lower-tail inference $c_{\alpha}$ must satisfy
$$
P\left(\max _{i} \frac{\left(\bar{y}_{0}-\mu_{0}\right)-\left(\bar{y}_{i}-\mu_{i}\right)}{\hat{\sigma} \sqrt{2 / n}} \leq c_{\alpha}\right)=1-\alpha
$$
and in the case of upper-tail inference $c_{\alpha}$ must satisfy
$$
P\left(\max _{i} \frac{\left(\bar{y}_{i}-\mu_{i}\right)-\left(\bar{y}_{0}-\mu_{0}\right)}{\hat{\sigma} \sqrt{2 / n}} \leq c_{\alpha}\right)=1-\alpha
$$


**SAS Implementation**

```
ods graphics on;
proc glm data=Tox;
 class Trt;
 model Gain=Trt;
 means Trt/dunnettl;
run; quit;
ods graphics off; 
```

**Graphing the One-Sided Dunnett Comparisons**

```
lsmeans Trt/pdiff=controll;
```

```{r One-Sided Dunnett Comparisons, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Displaying One-Sided Dunnett Comparisons Graphically"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/Dunnett_OneSide.png")
```






### Maximum Modulus Distribution, Multiple Inferences for Independent Estimates

Whereas the distributions used in
Tukey's and Dunnett's tests concern estimates that are dependent, the studentized maximum
modulus distribution concerns estimates that are independent. The most common applications of
this distribution are to confidence intervals for means and to orthogonal comparisons

**Simultaneous Intervals for the Treatment Means**

Suppose that you want simultaneous confidence intervals for the group means themselves, rather than for their differences. $c_{\alpha}$ for which
$$
P\left(\bar{y}_{i}-c_{\alpha} \hat{\sigma} / \sqrt{n} \leq \mu_{i} \leq \bar{y}_{i}+c_{\alpha} \hat{\sigma} / \sqrt{n}, \text { for all } i\right)=1-\alpha
$$
Rearranging terms algebraically,
$$
P\left(\max _{i} \frac{\left|\left(\bar{y}_{i}-\mu_{i}\right)\right|}{\hat{\sigma} / \sqrt{n}} \leq c_{\alpha}\right)=1-\alpha
$$
Since the $\bar{y}_{i}$ are independent, the $t_{i}=\left(\bar{y}_{i}-\mu_{i}\right) /(\hat{\sigma} / \sqrt{n})$ values are nearly independent, too.
They're not quite independent because they share a common pooled variance estimate $\hat{\sigma}^{2}$. Thus, you could use Šidák's method, to approximate $c_{\alpha}$ as the $1-(1-\alpha)^{1 / g}$ quantile of the $t$ -distribution. However, an exact value for $c_{\alpha}$ can be calculated using Tukey's (1953) maximum modulus distribution.

**The Maximum Modulus Distribution**

If $Z_{0}, Z_{1}, \ldots, Z_{g}$ are independent standard normal random variables, and $V$ is a random variable distributed as chi-square with $v$ degrees of freedom, independent of the $Z \mathrm{~s}$, then
$$
Q_{g, v}^{M M}=\frac{\max _{i}\left|Z_{i}\right|}{\sqrt{V / v}}
$$
has the maximum modulus distribution with parameters $g$ and $v$.
You can see that the $c_{\alpha}$ for the simultaneous confidence intervals satisfies
$$
P\left(Q_{g, g(n-1)}^{M M} \leq c_{\alpha}\right)=1-\alpha
$$
or in other words, $c_{\alpha}=q_{1-\alpha, g, g(n-1)}^{M M}$, where $q_{1-\alpha, r}^{M M}$ is the $1-\alpha$ quantile of the maximum modulus distribution.


**SAS Implementation**

```
*** Simultaneous Confidence Intervals for Means;
proc glm data=Wloss;
 class Diet;
 model Wloss=Diet;
 means Diet / clm smm sidak;
run; 
```

Since the intervals are almost independent, Šidák’s adjustment provides a very close
approximation to the maximum modulus method. Using the maximum modulus
distribution yields very slightly (about 0.2%) tighter intervals. 


## Multiple Comparisons among Treatment Means in the One-Way Unbalanced ANOVA 

For unbalanced sample sizes, s, the simple distributions such as Tukey's studentized range and Dunnett's range distributions no longer are valid. The standard errors differ from contrast to contrast, and the simple range distributions can no longer be used directly.

### The Model and Estimates

$$
y_{i j}=\mu_{i}+\varepsilon_{i j}
$$
with independent, homoscedastic, and normally distributed $\varepsilon_{i j}$ having mean zero.

In the balanced case, the within-group samples all have the same size $n$. In the unbalanced case, we allow them to differ, denoting the size of the $i^{\text {th }}$ sample by $n_{i}$, for $i=1, \ldots, g$. The estimated parameters are $\hat{\mu}_{i}=\bar{y}_{i}=\left(1 / n_{i}\right) \sum_{j=1}^{n_{i}} y_{i j}$, and $\hat{\sigma}^{2}=\Sigma_{i=1}^{g}\left\{\left(n_{i}-1\right) s_{i}^{2}\right\} / \Sigma_{i=1}^{g}\left(n_{i}-1\right)$, where $s_{i}^{2}$ is the
ordinary sample variance estimate for group $i, s_{i}^{2}=\sum_{j=1}^{n_{i}}\left(y_{i j}-\bar{y}_{i}\right)^{2} /\left(n_{i}-1\right)$. The degrees of freedom for the estimate of $\sigma^{2}$ is the error degrees of freedom $d f e=\sum_{i=1}^{g}\left(n_{i}-1\right)=N-g$, where
$N=\Sigma_{i=1}^{g} n_{i}$ is the total of all within-group sample sizes.


**All Pairwise Comparisons**

The confidence intervals for the difference of means $\mu_{i}-\mu_{i^{\prime}}$ have the form
$$
\bar{y}_{i}-\bar{y}_{i^{\prime}} \pm c_{\alpha} \hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i^{\prime}}}
$$
where $\bar{y}_{i}-\bar{y}_{i^{\prime}}$ is the usual least-squares estimate of $\mu_{i}-\mu_{i^{\prime}}$ and $\hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i}}$ is its standard error. In the case of non-multiplicity-adjusted confidence intervals, you set $c_{\alpha}$ to be the $1-\alpha / 2$ quantile of the $t_{d f e}$ distribution, $t_{1-\alpha / 2, d f e}$, with $d f e=N-g$. As always, you can construct Bonferroni-adjusted confidence intervals by setting $c_{\alpha}=t_{1-\alpha^{\prime} / 2, d f e}$, where $\alpha^{\prime}=\alpha / k, k$ being the number of inferences (e.g., pairwise comparisons) in the family. And, as always, you can improve upon the Bonferroni value by taking into account the distribution of the differences.

Mathematically, $c_{\alpha}$ must satisfy
$P\left(\bar{y}_{i}-\bar{y}_{i}-c_{\alpha} \hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i}} \leq \mu_{i}-\mu_{i^{\prime}} \leq \bar{y}_{i}-\bar{y}_{i^{\prime}}+c_{\alpha} \hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i}}\right.$, for all $\left.i, i^{\prime}\right)=1-\alpha$
or equivalently,
$$
P\left(\max _{i, i^{\prime}} \frac{\left|\left(\bar{y}_{i}-\mu_{i}\right)-\left(\bar{y}_{i^{\prime}}-\mu_{i^{\prime}}\right)\right|}{\hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i}}} \leq c_{\alpha}\right)=1-\alpha
$$

Unlike the balanced case, the denominator of this expression, $\hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i^{\prime}}}$, is **not constant** for all $\left(i, i^{\prime}\right)$ pairs. Thus, the MaxT statistic does **not have the studentized range distribution**; its distribution is actually quite complicated.



### Tukey-Kramer Method 

Tukey (1953) and Kramer (1956) independently proposed a method to approximate the critical value $c_{\alpha}$ in unbalanced designs. Recall that when the sample sizes are all equal (i.e., when $\left.n_{1}=\ldots=n_{g}=n\right)$, the statistic
$$
\max _{i, i^{\prime}} \sqrt{2}\left|T_{i, i^{\prime}}\right|=\max _{i, i} \sqrt{2}\left|\frac{\left(\bar{y}_{i}-\mu_{i}\right)-\left(\bar{y}_{i^{\prime}}-\mu_{i^{\prime}}\right)}{\hat{\sigma} \sqrt{1 / n+1 / n}}\right|
$$
is distributed as $Q_{g, g(n-1)}^{R}$, which has the studentized range distribution


which gives the Tukey-Kramer simultaneous confidence intervals:
$$
\bar{y}_{i}-\bar{y}_{i^{\prime}} \pm\left(q_{1-\alpha, g, d f e}^{R} / \sqrt{2}\right) \hat{\sigma} \sqrt{1 / n_{i}+1 / n_{i}}
$$
Note that, as in the balanced case, the critical value $c_{\alpha}$ is the $1-\alpha$ quantile of the range distribution divided by $\sqrt{2}$. Thus, there are no real differences in the form of the Tukey-Kramer intervals and the Tukey intervals.

If you apply the above confidence interval formula in the case where all $n_{i}$ are equal (to $n$ ), you get exactly the Tukey intervals for all pairwise comparisons.
However, the Tukey-Kramer intervals are not exact in the sense of providing an exact simultaneous $1-\alpha$ coverage rate and exact $\mathrm{FWE}=\alpha$ when the sample sizes are unequal. Hayter
(1984) proved that the method is in fact **conservative**: the true FWE is **less than or equal** to $\alpha$ for all possible sample size configurations.



**SAS Implementation**

When you specify TUKEY as an option for the MEANS statement, the Tukey-Kramer method
is used automatically when the sample sizes are unequal. This code produces the following
output. 

```
data Recover;
 input Blanket$ Minutes @@;
 datalines;
b0 15 b0 13 b0 12 b0 16 b0 16 b0 17 b0 13 b0 13 b0 16 b0 17
b0 17 b0 19 b0 17 b0 15 b0 13 b0 12 b0 16 b0 10 b0 17 b0 12
b1 13 b1 16 b1 9
b2 5 b2 8 b2 9
b3 14 b3 16 b3 16 b3 12 b3 7 b3 12 b3 13 b3 13 b3 9 b3 16
b3 13 b3 18 b3 13 b3 12 b3 13
;
proc sgplot data=Recover;
 vbox Minutes / category=Blanket;
run;
proc glm data=Recover;
 class Blanket;
 model Minutes=Blanket;
 means Blanket/tukey;
run; 
```

### Alternative Simulation-Based Method

The Tukey-Kramer method is conservative because the critical value $q_{1-\alpha, g, N-g}^{R}$ is larger than the true $c_{\alpha}$, which is the $1-\alpha$ quantile of the distribution of $\max _{i, i}\left|T_{i, i}\right| .$ To calculate the correct critical value analytically requires multidimensional integration using the **multivariate $t$ distribution**, you can approximate this critical value very easily **by simulating from the multivariate $t$ distribution** with $d f e=N-g$ and dispersion matrix $\mathbf{R}=\mathbf{D}^{-1 / 2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C} \mathbf{D}^{-1 / 2}$. The following simulation algorithm avoids the problem of having to specify the $\mathbf{R}$ matrix, and illustrates the concept of **parametric resampling**. 

 
1. Generate a random sample $y_{i j}^{*}$ from the standard normal distribution.
2. Analyze the data exactly as you would if it were an actual data set, getting sample means $\bar{y}_{i}^{*}$ and a pooled variance estimate $\left(\hat{\sigma}^{*}\right)^{2}$. Compute the test statistics for all pairwise comparisons, $T_{i, i^{\prime}}^{*}=\left(\bar{y}_{i}^{*}-\bar{y}_{i^{\prime}}^{*}\right) /\left(\hat{\sigma}^{*} \sqrt{1 / n_{i}+1 / n_{i^{\prime}}}\right)$.
3. Calculate the value $\operatorname{Max} \mathrm{T}=\max _{i, i^{\prime}}\left|T_{i, i^{\prime}}^{*}\right|$ and store it.
4. Repeat steps 1-3 NSAMP times, and estimate $c_{\alpha}$ as the $1-\alpha$ quantile of the resulting
MaxT values. Call the resulting value $\hat{c}_{\alpha}$.

**Simulating the Critical Value for Recovery Data Using Parametric Resampling**

```
data sim;
 array nsize{4} (20,3,3,15);
 do rep = 1 to 20000;
 do i=1 to dim(nsize);
 do j=1 to nsize{i};
 y = rannor(121211);
 output;
 end;
 end;
 end;
run;
ods listing close;
proc glm data=sim;
 by rep;
 class i;
 model y=i;
 lsmeans i/ tdiff;
 ods output Diff=GDiffs;
quit;
ods listing;
proc transpose data=GDiffs out=t(where=(_label_ > RowName));
 by rep RowName;
 var _1 _2 _3 _4;
data t;
 set t;
 abst = abs(COL1);
 keep rep abst;
proc means noprint data=t;
 var abst;
 by rep;
 output out=maxt max=maxt;
run;
proc univariate;
 var maxt;
 ods select Quantiles;
run; 
```

Thus, the correct 95th percentile is estimated to be 2.646847, based on NSAMP=20000
simulations. The Tukey-Kramer approximation resulted in a slightly higher number, 2.68976,
which suggests a slight level of conservatism of the Tukey-Kramer method.

```
100% Max 4.844511
99% 3.288458
95% 2.646847
90% 2.332767
75% Q3 1.851581
50% Median 1.381995
25% Q1 0.981263
10% 0.681271
5% 0.528405
1% 0.293808
0% Min 0.036276
```
However, remember that the percentile estimated by simulation is subject to **sampling error**, so the precise degree of conservatism is unclear. Edwards and Berry (1987) suggest generating sufficient samples NSAMP so that $P\left(\operatorname{Max} T \geq \hat{c}_{\alpha}\right)$ (where $\hat{c}_{\alpha}$ is fixed and MaxT is random) is within an accuracy radius $\gamma$ of $\alpha$ with confidence $100(1-\delta) \%$. You can adjust $\alpha$ using the ALPHA= option, and $\gamma$ and $\delta$ with the ACC $=$ and EPS $=$ suboptions of the ADJUST=SIMULATE option, respectively. By default, $\alpha=0.05, \gamma=0.005$, and $\delta=0.01 ;$ the method yields $\mathrm{NSAMP}=12,604$ in this case. That is, using quantiles from a simulation of this size, a nominal $95 \%$ confidence interval for a mean difference will actually have between $94.5 \%$ and $95.5 \%$ confidence with probability $0.99$ 

If you specify the ADJUST=SIMULATE option then PROC GLM uses the simulationestimated quantile in forming multiplicity-adjusted confidence intervals for the differences. Although PROC GLM doesn't display the actual value of the quantile by default, you can use the **REPORT option** for the simulation to print the quantile and other information,

```
proc glm data=Recover;
 class Blanket;
 model Minutes=Blanket;
 lsmeans Blanket/cl adjust=simulate(seed=121211 report);
 ods select SimResults LSMeanDiffCL;
run;
```
$$
\begin{array}{lcccc}
\hline & \text { Simulation Results } & & \\
\text { Method } & \text { 95% Quantile } & \text { Estimated } & \text {99% CI } \\
\text { Simulated } & 2.634412 & 0.0500 &  0.0450 & 0.0550\\
\text { Tukey-Kramer } & 2.689757 & 0.0432 & 0.0385 & 0.0478 \\
\text { Bonferroni } & 2.787602 & 0.0338 & 0.0297 & 0.0379 \\
\text { Sidak } & 2.779230 & 0.0346 & 0.0304 & 0.0388 \\
\text { GT-2 } & 2.770830 & 0.0350 & 0.0308 & 0.0392 \\
\text { Scheffe } & 2.928547 & 0.0237 & 0.0202 & 0.0272 \\
T & 2.026192 & 0.1870 & 0.1780 & 0.1959 \\
\hline
\end{array}
$$

### Pairwise Comparisons with Control 

Unlike the case of all pairwise comparisons, the critical value cα and the adjusted p-values can
be calculated analytically for Dunnett's method in the case of all pairwise comparisons with a
control, even though the design is unbalanced. There is no need to use approximations, such as
the Tukey-Kramer or simulation-based. 

Suppose the means are $\bar{y}_{0}, \bar{y}_{1}, \ldots, \bar{y}_{g}$, where $\bar{y}_{0}$ denotes the sample mean for the control group.

To get the critical values and adjusted $p$ -values for two-sided intervals and tests, you need the distribution of
$$
M_{2}=\max _{i} \frac{\left|\bar{y}_{i}-\bar{y}_{0}\right|}{\hat{\sigma} \sqrt{1 / n_{i}+1 / n_{0}}}
$$
The critical value $c_{\alpha}$ for the two-sided confidence intervals for $\mu_{i}-\mu_{0}$ is the $1-\alpha$ quantile of the distribution of $M_{2}$, and adjusted $p$ -values for two-sided tests are given as
$\tilde{p}_{i}=P\left(M_{2} \geq\left|t_{i}\right|\right)$, where $t_{i}$ is the test statistic for $H_{0 i}: \mu_{i}-\mu_{0}=0$, i.e.,
$$
t_{i}=\left(\bar{y}_{i}-\bar{y}_{0}\right) /\left(\hat{\sigma} \sqrt{1 / n_{i}+1 / n_{0}}\right)
$$
To get the critical values and adjusted $p$ -values for one-sided intervals and tests, you need the distribution of
$$
M_{1}=\max _{i} \frac{\bar{y}_{i}-\bar{y}_{0}}{\hat{\sigma} \sqrt{1 / n_{i}+1 / n_{0}}}
$$
The critical value $c_{\alpha}$ for the one-sided confidence bounds is the $1-\alpha$ quantile of the
distribution of $M_{1}$. Adjusted $p$ -values for one-sided, upper-tail tests are given as $\tilde{p}_{i}=P\left(M_{1} \geq t_{i}\right)$, and adjusted $p$ -values for one-sided, lower-tail tests are given as $\tilde{p}_{i}=P\left(M_{1} \geq-t_{i}\right)$


**Dunnett's Two-Sided Comparisons with Unbalanced Data**

```
ods graphics on;
proc glm data=Recover;
 class Blanket;
 model Minutes = Blanket;
 lsmeans Blanket/pdiff cl adjust=dunnett;
run;
ods graphics off;
```

**Dunnett's One-Sided Comparisons with Unbalanced Data**


```
** “By Hand” Calculation of Dunnett's Exact One-Sided Critical Value 
    and Adjusted p-Value for Unbalanced ANOVA.
data;
 n0=20; n1=3; n2=3; n3=15;
 lambda1 = sqrt(n1/(n0+n1));
 lambda2 = sqrt(n2/(n0+n2));
 lambda3 = sqrt(n3/(n0+n3));
 c_alpha = probmc('DUNNETT1',.,.90,37,3,lambda1,lambda2,lambda3);
 t3 = -1.66666667/0.88477275;
 adjp_3 = 1-probmc('DUNNETT1',-t3,.,37,3,lambda1,lambda2,lambda3);
run; 


ods graphics on;
proc glm data=Recover;
 class Blanket;
 model Minutes = Blanket;
 lsmeans Blanket / pdiff=controll cl alpha=0.10;
run;
ods graphics off;
```


### Comparisons with the Average Mean–Analysis of Means (ANOM) 


whether one group’s mean is confidently different from the average of the means for the set of groups as a
whole. Using this method, a quality control engineer can confidently identify troubled or
unusually good spots (e.g., a shift that is under- or over-performing) or a product formulation or
business process that should be abandoned or emulated. 

```
ods graphics on;
proc glm data=Recover;
 class Blanket;
 model Minutes = Blanket;
 lsmeans Blanket / pdiff=anom(weighted) cl alpha=0.10;
run;
ods graphics off; 
```


## Generalizations for the Analysis of Covariance (ANCOVA) model

A major difference is that the comparisons of interest in ANCOVA are differences of **LS-means rather than ordinary means**. This leads to some interesting graphical comparisons using regression functions. As in the unbalanced one-way case, the **standard errors of estimated LS-mean differences are not constant**, implying that simple range distributions (Tukey-type or Dunnett-type) cannot be used. Also, while for Dunnett comparisons there is an exact representation of the MaxT distribution in the case of unbalanced sample sizes without covariates, this is not the case when there are covariates. Hence, either simulation-based or analytic approximations must be used. 

> 一个主要的区别是在ANCOVA中感兴趣的比较是LS-均值的差异，而不是普通方法。这导致使用回归函数进行一些有趣的图形比较。与不平衡单向情况一样，估计的LS均值差的标准误差也不是恒定的，这意味着不能使用简单的范围分布（Tukey型或Dunnett型）。同样，对于Dunnett比较而言，在样本量不平衡且没有协变量的情况下，可以精确地表示MaxT分布，而在有协变量的情况下，情况并非如此。因此，必须使用基于仿真的近似值或解析近似值。
 

ANCOVA model with interaction may be written as
$$
y_{i j}=\gamma+\mu_{i}+\beta x_{i j}+\varepsilon_{i j}
$$
where parallelism is indicated by the common slope $\beta$ for all groups.

A recommendation is generally to use the SAS defaults (**Tukey-Kramer, Dunnett-Hsu**) for ANCOVA applications: although they are not exact, their accuracy is usually completely adequate from a practical perspective, and they avoid the troublesome issue of simulation nondeterminacy. Nevertheless, it is prudent to validate the default analysis using the simulation adjustments.



### Dunnett-Hsu Factor Analytic Approximation 

> Pairwise Comparisons in ANCOVA

* Tukey's range, Dunnett's range, and the maximum modulus distributions to account for dependencies among the estimates. 
* The Range distribution becomes inexact in the case of unbalanced data, while the Dunnett one- and twosided distributions remain exact (with suitable modifications). 
* When you include covariates, none of these distributions is exact in general. The general alternative of simulation is still available, though, and quantiles can be simulated with relative ease and adequate accuracy using the ADJUST=SIMULATE option.

There is an analytical **approximation** that works very well, providing critical values that, while not analytically exact, are exceptionally accurate. In fact, the deterministic error in this analytical approximation is usually much smaller than the Monte Carlo error of the simulation-based methods at reasonable sample sizes. 




<!-- 除非在MaxT统计量的构成差异之间的相关矩阵之间具有相关性具有一定的对称性，否则评估MaxT分布的临界值和调整的p值是很难的。 -->

As has been discussed, evaluating the critical values and adjusted $p$ -values for the MaxT distribution is intractable unless the correlation matrix $\mathbf{R}=\mathbf{D}^{-1 / 2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C} \mathbf{D}^{-1 / 2}$ between the constituent differences in the MaxT statistic has a certain symmetry, in which case the problem reduces to a feasible 2 -fold integral. 

The required symmetry is provided by complete balance in the case of Tukey's test, and by a factor analytic structure (cf. Hsu, 1992 ) in the case of Dunnett's test. To be precise, the $\mathbf{R}$ matrix has the required symmetry for exact computation of Tukey's test if the test statistics $t_{i}$ are studentized differences between

- $k(k-1) / 2$ pairs of $k$ uncorrelated means with equal variances, that is, equal sample sizes
- $k(k-1) / 2$ pairs of $k$ LS-means from a variance-balanced design (for example, a balanced incomplete block design)

  
In the case of comparisons with a control, the $\mathbf{R}$ matrix has the factor analytic structure for exact computation of Dunnett's test if the $t_{i}$ 's are studentized differences between


<!-- 在与控件进行比较的情况下，如果$t_ {i}$是学生之间的差异，则$\mathbf {R}$矩阵具有用于精确计算Dunnett检验的因子分析结构。 -->

- $k-1$ means and a control mean, all uncorrelated. Note that it is not required that the variances of the estimated means (that is, the sample sizes) be equal.
- $k-1$ LS-means and a control LS-mean from either a variance-balanced design, or a design in which the other factors are orthogonal to the treatment factor (for example, a randomized block design with proportional cell frequencies)

However, other important situations that do not result in a correlation matrix $\mathbf{R}$ that has the symmetry required for exact computation include

<!-- 但是，其他不会导致具有精确计算所需对称性的相关矩阵$ \ mathbf {R} $的其他重要情况包括：
所有成对的差异，样本大小均不相等 
当存在协变量时，LS均值和对照LS均值之间的差异。-->

- all pairwise differences with unequal sample sizes
- differences between LS-means and a control LS-mean when there are covariates.

In these situations, exact calculation of critical values and adjusted $p$ -values is intractable in general. For comparisons with a control when the correlation $\mathbf{R}$ does not have a factor analytic structure, Hsu (1992) suggests approximating $\mathbf{R}$ with a matrix $\mathbf{R}^{\mathrm{F}}$ that does have such a structure and, correspondingly, approximating the MaxT critical values and $p$ -values by assuming that the true correlation matrix is $\mathbf{R}^{\mathrm{F}}$. The resulting critical values and adjusted $p$ values are calculated exactly for the correlation $\mathbf{R}^{\mathrm{F}}$, but are approximate for the true correlation
R. (Approximating $\mathbf{R}$ in this way can also be viewed as computing "effective sample sizes" $\tilde{n}_{i}$ for the means and treating them as uncorrelated.)

<!-- 在这些情况下，通常很难计算出临界值和调整后的$ p $值。为了在相关$ \ mathbf {R} $不具有因子分析结构的情况下与控件进行比较，Hsu（1992）建议使用矩阵$ \ mathbf {R} ^ {\ mathrm { F}} $具有这样的结构，并通过假设真实的相关矩阵为$ \ mathbf {R} ^ {\ mathrm {F}} $来近似地近似MaxT临界值和$ p $ -values。精确计算出相关系数$ \ mathbf {R} ^ {\ mathrm {F}} $的结果临界值和调整后的$ p $值，但对于真实相关性则近似R。 -->

When you request Dunnett's test for LS-means (the PDIFF=CONTROL and
ADJUST=DUNNETT options), the GLM procedure automatically uses Hsu's approximation
when appropriate

```
proc glm data=House;
 class Location;
 model Price = Location Sqfeet;
 lsmeans Location / tdiff=control('B') pdiff cl;
run;
quit;
```

### Hsu-Nelson Simulation-Based Approximation: CVADJUST Method

> Pairwise Comparisons in ANCOVA


* simple Monte Carlo method 
* simulate MaxT values for the correct correlation $\mathbf{R}=\mathbf{D}^{-1 / 2} \mathbf{C}^{\prime}\left(\mathbf{X}^{\prime} \mathbf{X}\right)^{-} \mathbf{C} \mathbf{D}^{-1 / 2}$
* simulate covariate of MaxT values with known distribution for the factor-analytic approximation correlation $\mathbf{R}^{\mathrm{F}}$

A useful way to strengthen the simple Monte Carlo method of estimating confidence limits and p-values is to use the method of control variates. This method proceeds by simulating not only MaxT values for the correct correlation but also a covariate of MaxT values with known distribution for the factor-analytic approximation correlation discussed above. The conditional estimates for the correct distribution, conditional on the approximate but known one, can be much tighter than what you get with simple simulation (see Hsu and Nelson, 1998). To use this method, you can request it using the CVADJUST suboption of the ADJUST=SIMULATE option of the LSMEANS statement. 

```
lsmeans Location/tdiff=control('B') pdiff
 adjust=simulate(acc=0.0001 seed=121211 cvadjust report) cl;
```

### Comparisons in ANCOVA Models with Interaction 

The ANCOVA model with interaction may be written as
$$
y_{i j}=\gamma+\mu_{i}+\beta x_{i j}+\beta_{i} x_{i j}+\varepsilon_{i j},
$$
where $i$ denotes CLASS level and $j$ an observation within the CLASS level; where $\gamma$ is the overall intercept term and the $\mu_{i}$ parameterize deviations from the overall intercept for CLASS level $i$, and where similarly $\beta$ is the overall slope term, and the $\beta_{i}$ correspond to deviations from the overall slope for CLASS level $i$. The model is overparameterized, meaning that not all parameters can be estimated simultaneously without imposing additional constraints

```
*** One-Way ANCOVA Analysis with Interaction;
ods graphics on;
proc glm data=House;
 class Location;
 model Price = Location Sqfeet location*sqfeet;
run;
quit;
ods graphics off;
```

```{r ACNOVA Effect, echo=FALSE, fig.align="center", out.width = '100%',fig.cap="Figure: Fitted ANCOVA Model with Interaction"}
knitr::include_graphics("/Users/zehuibai/Documents/GitHub/As-a-Statistician/02_Plots/ACNOVA_Effect.png")
```

There is some suggestion of interaction in that the effect of SQFEET on PRICE seems less in LOCATION C, but this may be an artifact due to small sample size, because the interaction is not statistically significant (for testing $H_{0}: \beta_{1}=\ldots=\beta_{5}=0, F(4,54)=1.54, p=0.2045$ ). Nevertheless, the graph illustrates clearly that comparisons of housing prices between levels of the CLASS variable differ, depending on the chosen value of the covariate.

In PROC GLM, the default for **LSMEANS is to compare the CLASS levels at the average value(s) of the covariate(s)**. In the housing example, the average value of SQFEET is $1947.28125$, thus the statements

`lsmeans Location / adjust=tukey cl;` is equel to `lsmeans Location / adjust=tukey cl at Sqfeet=1947.28125;`
















